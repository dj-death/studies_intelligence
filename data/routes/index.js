var fs=require("fs"),mongoose=require("mongoose"),db=mongoose.connect("mongodb://127.0.0.1/smgr"),reload,Element=mongoose.model("elements",new mongoose.Schema({name:String,code:String,progress:{type:Number},spentTime:{type:Number},timeInvestPart:{type:Number},rendement:{type:Number},quota:{type:Number},done:Boolean,expanded:Boolean,module:String,children:[{}]})),History=mongoose.model("histories",new mongoose.Schema({Anglais:Number,Info:Number,Compta:Number,Org:Number,Money:Number,Problems:Number,Algebre:Number,Probas:Number,Ref:Number,dateStr:String,date:String})),Mixed=mongoose.Schema.Types.Mixed,Root=mongoose.model("roots",new mongoose.Schema({data:Mixed})),notDone=true;exports.init=function(a){reload=function(){a.reload()}};exports.index=function(b,a){a.sendfile("index.html")};exports.loadElements=function(b,a){Element.find({},function(g,h){var f,c,e,d;if(h.length===0&&notDone){notDone=false;e=require("../initial_data/contents_data.js").getContentsInitialData();c=e.length;for(f=0;f<c;f++){d=new Element();d.set(e[f]);d.save()}}a.contentType("json");a.json({success:!g,data:h})})};exports.newElement=function(c,b){var d=new Element(),a=c.body;delete a._id;d.set(a);d.save(function(f,e){b.contentType("json");b.json({success:!f,data:e})})};exports.getElement=function(b,a){Element.findById(b.params.id,function(d,c){a.contentType("json");a.json({success:true,data:[c]})})};exports.updateElement=function(b,a){Element.find({_id:b.params.id},function(d,e){var c=e[0];c.set(b.body);c.save(function(f){a.contentType("json");a.json({success:!f,data:b.body})})})};exports.destroyElement=function(b,a){Element.remove({_id:b.params.id},function(c,d){a.contentType("json");a.json({success:!c,data:[]})})};exports.loadHistory=function(b,a){History.find({},function(d,c){if(c.length===0){var e=new History();e.set({dateStr:"2012-09-15",date:"2012-09-15"});e.save(function(f,g){reload()})}a.contentType("json");a.json({success:!d,data:c})})};exports.newHistory=function(c,b){var a=new History(),d=c.body;delete d._id;a.set(d);a.save(function(e,f){b.contentType("json");b.json({success:!e,data:f})})};exports.getHistory=function(b,a){History.findById(b.params.id,function(c,d){a.contentType("json");a.json({success:true,data:[d]})})};exports.updateHistory=function(b,a){History.find({_id:b.params.id},function(d,c){var e=c[0];e.set(b.body);e.save(function(f){a.contentType("json");a.json({success:!f,data:b.body})})})};exports.destroyHistory=function(b,a){History.remove({_id:b.params.id},function(d,c){a.contentType("json");a.json({success:!d,data:[]})})};exports.loadSauvegardes=function(b,a){fs.readdir("db",function(f,j){if(f){return false}var g=[],h=null,e,d,c=j.length;for(d=0;d<c;d++){h={};h.id=j[d];e=new Date(parseInt(j[d],10));h.date=e.toLocaleString();g.push(h)}a.contentType("json");a.json({data:g})})};exports.loadQuotes=function(d,b){var a=require("sqlite3"),c=new a.Database("data/proverbes.db"),e;c.serialize(function(){c.run("CREATE TABLE IF NOT EXISTS quotes (author TEXT, content TEXT, ref TEXT, lang TEXT, image TEXT)");e=Math.floor(51*Math.random())+1;c.get("SELECT rowid AS id, author, content, lang, ref, image FROM quotes WHERE rowid="+e,function(f,g){b.contentType("json");b.json({data:[g]});c.close()})})};exports.DropAll=function(){Element.remove({},function(a,b){if(a){return false}History.remove({},function(d,c){if(d){return false}notDone=true})})};