var app=require("appjs"),Express=require("express"),server=Express.createServer(),fs=require("fs"),zlib=require("zlib"),execFile=require("child_process").execFile,routes=require("./routes");process.title="Studies Intelligence";var window=app.createWindow({width:1024,height:700,icons:__dirname+"/icons",url:"http://localhost:3000/"});window.on("create",function(){window.frame.show();window.frame.maximize()});function launchExport(){var d,b,a=+(new Date()),c="./db/"+a;d=execFile("mongodb/bin/mongodump.exe",["--host","localhost","--db","smgr","--forceTableScan","--out",c],function(g,e,f){if(g!==null){return false}window.frame.openDialog({type:"save",title:"Exporter sous...",acceptTypes:["*.SMgr"]},function(i,h){if(i){return false}b=execFile("7zip/7za.exe",["a",h[0]+".SMgr",c+"/smgr"],function(l,j,k){if(l!==null){return false}})})})}function launchImport(){var c,a,b;window.frame.openDialog({type:"open",title:"Importer de...",acceptTypes:["*.SMgr"]},function(e,d){if(e){return false}c=execFile("7zip/7za.exe",["x",d[0]],function(h,f,g){b=f;if(h!==null){return false}a=execFile("mongodb/bin/mongorestore.exe",["--host","localhost","--db","smgr","--journal","--drop","--keepIndexVersion","./smgr"],function(k,i,j){if(k!==null){return false}fs.readdir("smgr",function(o,n){if(o){return false}var m,l=n.length;for(m=0;m<l;m++){fs.unlinkSync("smgr/"+n[m])}fs.rmdirSync("smgr");window.reload()})})})})}function dump(d){var c,a=+(new Date()),b="./db/"+a;c=execFile("mongodb/bin/mongodump.exe",["--host","localhost","--db","smgr","--forceTableScan","--out",b],function(g,e,f){if(g!==null){return false}d()})}function restoreTo(c){var b,a="db/"+c+"/smgr";dump(function(){b=execFile("mongodb/bin/mongorestore.exe",["--host","localhost","--db","smgr","--journal","--drop","--keepIndexVersion",a],function(f,d,e){if(f!==null){return false}window.reload()})})}window.on("ready",function(){window.require=require;window.process=process;window.module=module;window.launchExport=launchExport;window.launchImport=launchImport;window.restoreTo=restoreTo;window.dropAll=function(){dump(function(){routes.DropAll();window.reload()})};function a(){window.document.location.reload()}window.reload=a;window.addEventListener("keydown",function(b){if(b.keyIdentifier==="F12"||(b.keyCode===74&&b.metaKey&&b.altKey)){window.frame.openDevTools()}if(b.keyIdentifier==="F5"){a()}})});window.on("close",function(){});server.configure(function(){server.set("views",__dirname+"/views");server.set("view engine","jade");server.use(Express.bodyParser());server.use(Express.methodOverride());server.use(server.router);server.use(Express.static(__dirname+"/content"))});server.configure("development",function(){server.use(Express.errorHandler({dumpExceptions:true,showStack:true}))});server.configure("production",function(){server.use(Express.errorHandler())});routes.init(window);server.get("/",routes.index);server.get("/elements",routes.loadElements);server.post("/elements",routes.newElement);server.get("/elements/:id",routes.getElement);server.put("/elements/:id",routes.updateElement);server.del("/elements/:id",routes.destroyElement);server.get("/history",routes.loadHistory);server.post("/history",routes.newHistory);server.get("/history/:id",routes.getHistory);server.put("/history/:id",routes.updateHistory);server.del("/history/:id",routes.destroyHistory);server.get("/sauvegardes",routes.loadSauvegardes);server.get("/quotes",routes.loadQuotes);app.router.handle=server.handle.bind(server);server.listen(3000);